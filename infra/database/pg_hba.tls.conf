# Cartae - PostgreSQL Host-Based Authentication (TLS Mode)
# Session 81b - TLS/mTLS End-to-End
#
# Règles d'authentification PostgreSQL avec TLS
# - TOUTES connexions doivent utiliser SSL (hostssl)
# - Connexions depuis APP zone (172.21.0.0/24) uniquement
# - Authentification par certificat client (cert) + password (scram-sha-256)
#
# Format:
#   TYPE  DATABASE  USER  ADDRESS        METHOD  [OPTIONS]

# ==================================================
# CONNECTIONS LOCALES (UNIX socket)
# ==================================================

# Autoriser connexions locales (socket) sans SSL
# (Pour maintenance/admin depuis container PostgreSQL)
local   all       postgres                     peer
local   all       all                          peer

# ==================================================
# CONNECTIONS TLS (hostssl - SSL OBLIGATOIRE)
# ==================================================

# APP Zone (database-api) - TLS avec certificat client + password
# clientcert=verify-full : Vérifie certificat client signé par CA
hostssl   cartae    cartae    172.21.0.0/24    cert    clientcert=verify-full

# APP Zone (database-api) - Fallback TLS + password (si client cert non dispo)
hostssl   cartae    cartae    172.21.0.0/24    scram-sha-256

# Localhost (pour tests depuis host machine)
hostssl   all       all       127.0.0.1/32     scram-sha-256
hostssl   all       all       ::1/128          scram-sha-256

# ==================================================
# DENY NON-SSL CONNECTIONS (sécurité)
# ==================================================

# IMPORTANT: Rejeter TOUTES connexions non-SSL
# Pas de host (sans SSL), seulement hostssl (avec SSL)
# Ordre important: rules matchent de haut en bas, première match gagne

# Si connexion sans SSL → REJECT
host      all       all       0.0.0.0/0        reject
host      all       all       ::/0             reject

# ==================================================
# NOTES
# ==================================================

# 1. Modes SSL clients:
#    - sslmode=disable      : Pas de SSL (REJETÉ par config)
#    - sslmode=allow        : SSL si dispo (REJETÉ, pas assez sécurisé)
#    - sslmode=prefer       : SSL préféré (REJETÉ, pas assez sécurisé)
#    - sslmode=require      : SSL OBLIGATOIRE ✅
#    - sslmode=verify-ca    : SSL + vérif CA ✅✅
#    - sslmode=verify-full  : SSL + vérif CA + CN ✅✅✅ (RECOMMANDÉ)
#
# 2. Méthodes d'authentification:
#    - peer            : Unix user (local uniquement)
#    - md5             : MD5 password (DÉPRÉCIÉ, insécure)
#    - scram-sha-256   : SHA-256 password (RECOMMANDÉ)
#    - cert            : Certificat client X.509 (RECOMMANDÉ pour mTLS)
#
# 3. Option clientcert:
#    - clientcert=verify-ca   : Vérifie certificat signé par CA
#    - clientcert=verify-full : Vérifie CA + CN match username (STRICT)
#
# 4. Ordre des règles:
#    - Plus spécifique → moins spécifique
#    - Première match gagne
#    - Deny rules à la fin
#
# 5. Reload config après modification:
#    SELECT pg_reload_conf();
#    # Ou:
#    docker exec cartae-postgres pg_ctl reload
#
# 6. Vérifier connexions SSL actives:
#    SELECT pid, usename, client_addr, ssl, cipher
#    FROM pg_stat_ssl
#    JOIN pg_stat_activity ON pg_stat_ssl.pid = pg_stat_activity.pid;
#
# 7. Connexion depuis database-api (TLS + cert):
#    psql "host=postgres port=5432 dbname=cartae user=cartae \
#          sslmode=verify-full \
#          sslcert=/app/tls/client/database-api.crt \
#          sslkey=/app/tls/client/database-api.key \
#          sslrootcert=/app/tls/ca/ca.crt"
#
# 8. Connexion depuis database-api (TLS + password):
#    psql "host=postgres port=5432 dbname=cartae user=cartae \
#          sslmode=require \
#          password=${POSTGRES_PASSWORD}"
