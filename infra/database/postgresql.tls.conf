# Cartae - PostgreSQL Configuration (TLS Mode)
# Session 81b - TLS/mTLS End-to-End
#
# Configuration PostgreSQL avec TLS activé
# - Connexions chiffrées uniquement (ssl=on)
# - Certificat serveur (postgres.crt)
# - Vérification certificat client optionnelle (via pg_hba.conf)

# ==================================================
# SSL/TLS Configuration
# ==================================================

# Activer SSL (OBLIGATOIRE pour TLS)
ssl = on

# Certificat serveur PostgreSQL (signé par Cartae CA)
ssl_cert_file = '/var/lib/postgresql/tls/server/postgres.crt'
ssl_key_file = '/var/lib/postgresql/tls/server/postgres.key'

# CA root (pour vérifier certificats clients en mTLS)
ssl_ca_file = '/var/lib/postgresql/tls/ca/ca.crt'

# Cipher suites (TLS 1.3 + TLS 1.2 sécurisés uniquement)
ssl_ciphers = 'HIGH:!aNULL:!MD5:!3DES'

# Préférer cipher suites serveur (meilleure sécurité)
ssl_prefer_server_ciphers = on

# Version TLS minimum (TLS 1.2)
ssl_min_protocol_version = 'TLSv1.2'

# Version TLS maximum (TLS 1.3)
# ssl_max_protocol_version = 'TLSv1.3'

# ==================================================
# Connection Settings
# ==================================================

listen_addresses = '*'  # Écouter sur toutes interfaces (filtré par Docker network)
port = 5432
max_connections = 100

# ==================================================
# Authentication
# ==================================================

# Configuration dans pg_hba.conf
# Modes supportés:
# - sslmode=require     : TLS obligatoire, pas de vérif client cert
# - sslmode=verify-ca   : TLS + vérif CA client cert
# - sslmode=verify-full : TLS + vérif CA + CN client cert

# ==================================================
# Logging (pour audit TLS connections)
# ==================================================

log_connections = on
log_disconnections = on

# Log SSL connections
log_line_prefix = '%m [%p] %q%u@%d [SSL:%S] '

# Niveau de log (info pour voir SSL handshake)
log_min_messages = info
log_min_error_statement = error

# ==================================================
# Performance Settings (inchangés)
# ==================================================

shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 16MB
maintenance_work_mem = 64MB

# ==================================================
# WAL (Write-Ahead Logging) - Production
# ==================================================

wal_level = replica
max_wal_senders = 3
wal_keep_size = 128MB

# ==================================================
# Checkpoints
# ==================================================

checkpoint_timeout = 10min
checkpoint_completion_target = 0.9

# ==================================================
# Query Tuning
# ==================================================

random_page_cost = 1.1  # SSD optimized
effective_io_concurrency = 200

# ==================================================
# Autovacuum
# ==================================================

autovacuum = on
autovacuum_max_workers = 3

# ==================================================
# Client Connection Defaults
# ==================================================

timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

# ==================================================
# Notes
# ==================================================

# 1. Permissions fichiers certificats:
#    chmod 600 /var/lib/postgresql/tls/server/postgres.key
#    chmod 644 /var/lib/postgresql/tls/server/postgres.crt
#    chmod 644 /var/lib/postgresql/tls/ca/ca.crt
#
# 2. Vérifier propriétaire:
#    chown postgres:postgres /var/lib/postgresql/tls/server/*
#
# 3. Tester connexion TLS:
#    psql "host=postgres dbname=cartae user=cartae sslmode=require"
#
# 4. Tester mTLS (client cert):
#    psql "host=postgres dbname=cartae user=cartae sslmode=verify-full sslcert=/path/to/client.crt sslkey=/path/to/client.key sslrootcert=/path/to/ca.crt"
#
# 5. Vérifier SSL dans PostgreSQL:
#    SELECT * FROM pg_stat_ssl;
