# ============================================================================
# Docker Compose - Cartae Database Infrastructure
# ============================================================================
# Stack complète pour le développement:
# - PostgreSQL 16 avec pgvector (HNSW indexes)
# - pgAdmin 4 (interface web de gestion DB)
# - Volumes persistants pour données
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # PostgreSQL avec pgvector extension
  # ==========================================================================
  postgres:
    build:
      context: ./postgresql
      dockerfile: Dockerfile
    container_name: cartae-db
    restart: unless-stopped

    environment:
      # Credentials (à override via .env)
      POSTGRES_USER: ${POSTGRES_USER:-cartae}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-cartae_dev_password}
      POSTGRES_DB: ${POSTGRES_DB:-cartae}

      # Performance tuning
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    volumes:
      # Données persistantes (survit au redémarrage container)
      - postgres_data:/var/lib/postgresql/data

      # Backup directory (optionnel)
      - ./backups:/backups

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-cartae}"]
      interval: 10s
      timeout: 5s
      retries: 5

    networks:
      - cartae-network

  # ==========================================================================
  # pgAdmin 4 - Interface web de gestion PostgreSQL
  # ==========================================================================
  # Accessible sur http://localhost:5050
  # Login: admin@cartae.dev / admin (à changer en production)
  # ==========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: cartae-pgadmin
    restart: unless-stopped

    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@cartae.dev}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'

    ports:
      - "${PGADMIN_PORT:-5050}:80"

    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./pgadmin-config/servers.json:/pgadmin4/servers.json:ro
      - ./pgadmin-config/pgpass:/pgpass:ro

    depends_on:
      postgres:
        condition: service_healthy

    networks:
      - cartae-network

# ============================================================================
# Volumes persistants
# ============================================================================
volumes:
  postgres_data:
    name: cartae-postgres-data
    driver: local

  pgadmin_data:
    name: cartae-pgadmin-data
    driver: local

# ============================================================================
# Network isolé pour la stack Cartae
# ============================================================================
networks:
  cartae-network:
    name: cartae-network
    driver: bridge
