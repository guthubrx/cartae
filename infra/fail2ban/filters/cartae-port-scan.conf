#
# Fail2ban Filter for Port Scanning Detection
# Session 81g - Incident Response & Security Operations
#
# Détecte les tentatives de scan de ports (reconnaissance pré-attaque)
# Patterns détectés:
# - SYN scans (demi-connexions)
# - Connexions sur ports non-ouverts
# - Séquences de connexions suspectes
#

[INCLUDES]

# Inclure les définitions communes
# before = common.conf

[Definition]

# Pattern de failregex pour détecter port scanning
# Cherche dans syslog les connexions bloquées par iptables
failregex = ^.*kernel:.*\[UFW BLOCK\].*SRC=<HOST>.*$
            ^.*kernel:.*\[IPTABLES DROP\].*SRC=<HOST>.*$
            ^.*kernel:.*IN=.*SRC=<HOST>.*DPT=(?!22|80|443|3000|5432)\d+.*$
            ^.*sshd\[\d+\]: refused connect from <HOST>.*$
            ^.*sshd\[\d+\]: Did not receive identification string from <HOST>.*$

# Patterns spécifiques Cartae
# Détecte accès à des ports non-publics
failregex = ^.*cartae.*"msg":"Port scan detected".*"ip":"<HOST>".*$
            ^.*cartae.*"msg":"Connection to closed port".*"ip":"<HOST>".*"port":(?!80|443)\d+.*$
            ^.*nginx.*\[error\].*connection refused.*client: <HOST>.*$

# Pattern générique pour scans nmap/masscan
# Détecte signatures de scanners réseau
failregex = ^.*"user_agent":".*nmap.*".*"ip":"<HOST>".*$
            ^.*"user_agent":".*masscan.*".*"ip":"<HOST>".*$
            ^.*"user_agent":".*nikto.*".*"ip":"<HOST>".*$
            ^.*"user_agent":".*sqlmap.*".*"ip":"<HOST>".*$

# Ignore les scans de monitoring légitime
ignoreregex = ^.*"source":"nagios".*$
              ^.*"source":"prometheus".*$
              ^.*"user":"monitoring".*$

[Init]

# Date pattern pour syslog
datepattern = ^%%b\s+%%d %%H:%%M:%%S

# Mode multi-line désactivé
maxlines = 1

#
# Exemples de logs qui DOIVENT matcher:
#
# MATCH: Nov 15 10:30:00 server kernel: [UFW BLOCK] IN=eth0 SRC=203.0.113.100 DST=10.0.0.5 PROTO=TCP SPT=54321 DPT=8080
# MATCH: Nov 15 10:31:00 server kernel: [IPTABLES DROP] IN=eth0 SRC=198.51.100.50 DST=10.0.0.5 PROTO=TCP DPT=31337
# MATCH: Nov 15 10:32:00 server sshd[12345]: refused connect from 192.0.2.100 (192.0.2.100)
# MATCH: {"timestamp":"2025-11-15T10:33:00.000Z","level":"warn","msg":"Port scan detected","ip":"172.16.0.200","ports":[21,22,23,25,80,443]}
# MATCH: {"timestamp":"2025-11-15T10:34:00.000Z","level":"error","msg":"Connection to closed port","ip":"10.0.0.50","port":31337}
#
# IGNORE: {"timestamp":"2025-11-15T10:35:00.000Z","level":"info","msg":"Health check","ip":"10.0.0.10","source":"nagios"}
#
