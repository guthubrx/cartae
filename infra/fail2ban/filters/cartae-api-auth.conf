#
# Fail2ban Filter for Cartae API Authentication
# Session 81g - Incident Response & Security Operations
#
# Ce filtre parse les logs d'authentification de l'API Cartae
# pour détecter les échecs de login et tentatives d'accès non autorisé.
#
# Format attendu des logs (JSON):
# {"timestamp":"2025-11-15T10:23:45.123Z","level":"warn","msg":"Authentication failed","ip":"1.2.3.4","user":"admin","endpoint":"/api/auth/login","reason":"invalid_password"}
#

[INCLUDES]

# Inclure les définitions communes si nécessaire
# before = common.conf

[Definition]

# Pattern de failregex (regex Python avec VERBOSE flag)
# Détecte les logs JSON avec "Authentication failed"
failregex = ^.*"ip":"<HOST>".*"msg":"Authentication failed".*$
            ^.*"level":"warn".*"ip":"<HOST>".*"endpoint":"/api/auth/.*"reason":"invalid_(password|token|credentials)".*$
            ^.*"ip":"<HOST>".*"status":401.*"endpoint":"/api/auth/.*$
            ^.*"ip":"<HOST>".*"msg":"Unauthorized access attempt".*$
            ^.*"ip":"<HOST>".*"msg":"Invalid JWT token".*$
            ^.*"ip":"<HOST>".*"msg":"Token expired".*"reason":"malicious".*$
            ^.*"ip":"<HOST>".*"msg":"MFA challenge failed".*$
            ^.*"ip":"<HOST>".*"endpoint":"/api/auth/.*"status":(401|403).*$

# Pattern d'ignore (ne pas bannir pour ces cas)
# Exemple: Token expiré de manière légitime (pas un bruteforce)
ignoreregex = ^.*"reason":"token_expired".*"malicious":false.*$
              ^.*"msg":"Token refresh successful".*$
              ^.*"user":"system".*$

# Options du filtre
[Init]

# Date pattern pour parsing timestamps
# Support format ISO 8601 utilisé par Winston/Pino
datepattern = ^"timestamp":"%%Y-%%m-%%dT%%H:%%M:%%S\.%%f(?:%%z)?"

# Journal mode (systemd journal vs fichier plat)
# Cartae utilise fichiers plats
journalmatch =

# Préfixe de ligne (optionnel)
# Si logs commencent tous par un pattern commun
prefregex =

# Mode multi-line (si logs sur plusieurs lignes)
# Cartae logs JSON sont single-line
maxlines = 1

#
# Exemples de logs qui DOIVENT matcher (pour tests)
#
# MATCH: {"timestamp":"2025-11-15T10:23:45.123Z","level":"warn","msg":"Authentication failed","ip":"192.168.1.100","user":"admin","endpoint":"/api/auth/login","reason":"invalid_password"}
# MATCH: {"timestamp":"2025-11-15T10:24:12.456Z","level":"warn","ip":"10.0.0.50","endpoint":"/api/auth/token","status":401,"reason":"invalid_token"}
# MATCH: {"timestamp":"2025-11-15T10:25:33.789Z","level":"error","msg":"Unauthorized access attempt","ip":"172.16.0.200","endpoint":"/api/admin/users","user":null}
# MATCH: {"timestamp":"2025-11-15T10:26:01.234Z","level":"warn","msg":"Invalid JWT token","ip":"203.0.113.50","token":"eyJ...","reason":"signature_mismatch"}
# MATCH: {"timestamp":"2025-11-15T10:27:45.567Z","level":"warn","msg":"MFA challenge failed","ip":"198.51.100.75","user":"john","mfa_method":"totp"}
#
# IGNORE: {"timestamp":"2025-11-15T10:28:00.000Z","level":"info","msg":"Token expired","ip":"192.168.1.10","reason":"token_expired","malicious":false}
# IGNORE: {"timestamp":"2025-11-15T10:29:00.000Z","level":"info","msg":"Token refresh successful","ip":"192.168.1.10","user":"alice"}
#

#
# Test du filtre (commande à lancer manuellement):
#
# fail2ban-regex /var/log/cartae/api.log /etc/fail2ban/filter.d/cartae-api-auth.conf
#
# Doit afficher:
# - Lignes matchées avec IPs extraites
# - Lignes ignorées selon ignoreregex
# - Statistiques de matching
#
